<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify 履歴解析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #ffffff;
        }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-4xl mx-auto bg-gray-900 rounded-2xl shadow-xl p-8">
        <h1 class="text-4xl font-bold text-green-400 text-center mb-2">俺のSpotifyデータ解析　</h1>
        <p class="text-gray-400 text-center mb-8">
            Spotifyのストリーミング履歴データを含む任意のJSONファイルをアップロードしてくださいな。
        </p>

        <!-- ファイルアップロードセクション -->
        <div class="mb-8">
            <label for="fileInput" class="block text-lg font-medium text-gray-200 mb-2">
                履歴ファイルを選択してね。
                <span class="text-sm text-gray-500 block">(CtrlキーまたはCommandキーを押しながら複数選択できるしん)</span>
            </label>
            <input 
                type="file" 
                id="fileInput" 
                multiple 
                accept=".json"
                class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-green-50 file:text-green-700
                    hover:file:bg-green-100 cursor-pointer"
            >
            <!-- 選択されたファイル名を表示するコンテナ -->
            <div id="fileListContainer" class="mt-4 text-sm text-gray-400 flex flex-wrap gap-2"></div>
        </div>

        <!-- 結果表示セクション -->
        <div id="results" class="space-y-12 hidden">
            <!-- ローディングメッセージ -->
            <div id="loading" class="text-center">
                <p class="text-lg text-gray-300">データを解析中です...</p>
            </div>
            
            <!-- 年間合計再生時間 -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-green-300">各年の合計再生時間</h2>
                <div id="yearlyTimeResults" class="bg-gray-800 rounded-lg p-4"></div>
            </div>

            <!-- 年間トップ10曲（再生時間） -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-green-300">各年のTOP10曲 (再生時間)</h2>
                <div id="yearlyTopTimeResults" class="space-y-8"></div>
            </div>

            <!-- 年間トップ10曲（再生回数） -->
            <div>
                <h2 class="text-2xl font-semibold mb-4 text-green-300">各年のTOP10曲 (再生回数)</h2>
                <div id="yearlyTopCountResults" class="space-y-8"></div>
            </div>
        </div>

        <!-- エラーメッセージ表示セクション -->
        <div id="error-message" class="text-center text-red-400 p-4 hidden rounded-lg bg-red-900">
            <p>エラー: 無効なファイル形式か、データがありません。正しいSpotifyの履歴ファイルをアップロードしてください。</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            const errorMessageDiv = document.getElementById('error-message');
            const yearlyTimeResultsDiv = document.getElementById('yearlyTimeResults');
            const yearlyTopTimeResultsDiv = document.getElementById('yearlyTopTimeResults');
            const yearlyTopCountResultsDiv = document.getElementById('yearlyTopCountResults');
            const fileListContainer = document.getElementById('fileListContainer'); // 選択されたファイルリストのコンテナ

            fileInput.addEventListener('change', async (event) => {
                const files = event.target.files;
                
                // 選択されたファイル名の表示
                if (files.length > 0) {
                    const fileNamesHtml = Array.from(files).map(file => 
                        `<span class="bg-gray-700 text-green-300 px-3 py-1 rounded-lg">${file.name}</span>`
                    ).join('');
                    fileListContainer.innerHTML = `<p class="font-medium text-gray-300 mb-2">選択されたファイル (${files.length}件):</p>${fileNamesHtml}`;
                } else {
                    fileListContainer.innerHTML = '';
                    return;
                }

                resultsDiv.classList.add('hidden');
                errorMessageDiv.classList.add('hidden');
                loadingDiv.style.display = 'block';

                try {
                    const allRecords = await processFiles(files);
                    if (allRecords.length === 0) {
                        throw new Error('No valid data found.');
                    }
                    
                    const processedData = processRecords(allRecords);
                    displayResults(processedData);
                    resultsDiv.classList.remove('hidden');

                } catch (error) {
                    console.error('分析中にエラーが発生しました:', error);
                    errorMessageDiv.classList.remove('hidden');
                    resultsDiv.classList.add('hidden');
                } finally {
                    loadingDiv.style.display = 'none';
                }
            });

            // 選択されたファイルを読み込み、JSONデータを結合する
            async function processFiles(files) {
                const allRecords = [];
                for (const file of files) {
                    const fileContent = await readFileAsText(file);
                    try {
                        const data = JSON.parse(fileContent);
                        // 配列であることを確認（Spotify履歴ファイルは配列形式）
                        if (Array.isArray(data)) {
                            allRecords.push(...data);
                        } else {
                            throw new Error('Invalid JSON format');
                        }
                    } catch (e) {
                        // ファイルの読み込み・解析エラーはログに出力するが、処理は継続
                        console.error(`ファイル ${file.name} の解析に失敗しました:`, e);
                    }
                }
                return allRecords;
            }

            // FileReaderを使ってファイルをテキストとして読み込む
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            }

            // データの整形と集計を行う
            function processRecords(records) {
                const yearlyTime = new Map();
                const yearlyTopTime = new Map();
                const yearlyTopCount = new Map();

                records.forEach(record => {
                    // 視聴時間が短すぎるレコード（例: 1秒未満）は無視
                    if (record.ms_played === undefined || record.ms_played === null || record.ms_played < 1000) {
                        return; 
                    }

                    const ts = new Date(record.ts);
                    const year = ts.getFullYear();
                    const minutesPlayed = record.ms_played / 1000 / 60;
                    const trackName = record.master_metadata_track_name || '不明な曲';
                    const artistName = record.master_metadata_album_artist_name || '不明なアーティスト';
                    const key = `${trackName} - ${artistName}`;

                    // 年間合計再生時間
                    yearlyTime.set(year, (yearlyTime.get(year) || 0) + minutesPlayed);

                    // 年間トップ10曲（再生時間）
                    if (!yearlyTopTime.has(year)) {
                        yearlyTopTime.set(year, new Map());
                    }
                    const yearTimeMap = yearlyTopTime.get(year);
                    yearTimeMap.set(key, (yearTimeMap.get(key) || 0) + minutesPlayed);

                    // 年間トップ10曲（再生回数）
                    if (!yearlyTopCount.has(year)) {
                        yearlyTopCount.set(year, new Map());
                    }
                    const yearCountMap = yearlyTopCount.get(year);
                    yearCountMap.set(key, (yearCountMap.get(key) || 0) + 1);
                });

                // Top10を計算
                const sortedYearlyTopTime = new Map();
                yearlyTopTime.forEach((tracks, year) => {
                    const sortedTracks = [...tracks.entries()]
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);
                    sortedYearlyTopTime.set(year, sortedTracks);
                });

                const sortedYearlyTopCount = new Map();
                yearlyTopCount.forEach((tracks, year) => {
                    const sortedTracks = [...tracks.entries()]
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10);
                    sortedYearlyTopCount.set(year, sortedTracks);
                });

                return {
                    // 年を昇順にソート
                    yearlyTime: [...yearlyTime.entries()].sort((a, b) => a[0] - b[0]),
                    yearlyTopTime: sortedYearlyTopTime,
                    yearlyTopCount: sortedYearlyTopCount
                };
            }

            // 結果をHTMLに描画する
            function displayResults(data) {
                yearlyTimeResultsDiv.innerHTML = '';
                yearlyTopTimeResultsDiv.innerHTML = '';
                yearlyTopCountResultsDiv.innerHTML = '';

                // 年間合計再生時間の表示
                data.yearlyTime.forEach(([year, time]) => {
                    yearlyTimeResultsDiv.innerHTML += `
                        <p class="text-gray-200">
                            <span class="font-bold text-green-300">${year}年:</span>
                            ${Math.round(time).toLocaleString()} 分
                        </p>
                    `;
                });

                // 年間トップ10曲（再生時間）の表示
                data.yearlyTopTime.forEach((tracks, year) => {
                    const listHtml = tracks.map(([track, time], index) => {
                        const [trackName, artistName] = track.split(' - ');
                        return `
                            <li class="flex items-start space-x-2 text-gray-300">
                                <span class="text-lg font-bold w-6 flex-shrink-0 text-right text-green-400">${index + 1}.</span>
                                <div class="flex-grow min-w-0">
                                    <span class="block font-medium truncate">${trackName}</span>
                                    <span class="block text-xs text-gray-500 truncate">${artistName}</span>
                                </div>
                                <span class="text-sm text-gray-500 flex-shrink-0 whitespace-nowrap">(${Math.round(time).toLocaleString()} 分)</span>
                            </li>
                        `;
                    }).join('');
                    yearlyTopTimeResultsDiv.innerHTML += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-2 text-green-300">${year}年</h3>
                            <ul class="space-y-1">${listHtml}</ul>
                        </div>
                    `;
                });

                // 年間トップ10曲（再生回数）の表示
                data.yearlyTopCount.forEach((tracks, year) => {
                    const listHtml = tracks.map(([track, count], index) => {
                        const [trackName, artistName] = track.split(' - ');
                        return `
                            <li class="flex items-start space-x-2 text-gray-300">
                                <span class="text-lg font-bold w-6 flex-shrink-0 text-right text-green-400">${index + 1}.</span>
                                <div class="flex-grow min-w-0">
                                    <span class="block font-medium truncate">${trackName}</span>
                                    <span class="block text-xs text-gray-500 truncate">${artistName}</span>
                                </div>
                                <span class="text-sm text-gray-500 flex-shrink-0 whitespace-nowrap">(${count.toLocaleString()} 回)</span>
                            </li>
                        `;
                    }).join('');
                    yearlyTopCountResultsDiv.innerHTML += `
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-xl font-semibold mb-2 text-green-300">${year}年</h3>
                            <ul class="space-y-1">${listHtml}</ul>
                        </div>
                    `;
                });
            }
        });
    </script>
</body>
</html>
